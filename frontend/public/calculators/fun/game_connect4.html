<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART HUB | Connect 4</title>
    <!-- Use CDNs for Socket.io -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/custom.css">

    <style>
        .connect4-container {
            max-width: 700px;
            margin: 40px auto;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-color);
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .header h2 {
            font-size: 2.2rem;
            color: var(--primary-color);
        }

        .multiplayer-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
            border: 1px dashed var(--border-color);
        }

        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group input,
        .control-group select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-main);
            color: var(--text-color);
            outline: none;
        }

        button.btn-action {
            padding: 10px 20px;
            border: none;
            background: var(--primary-gradient);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button.btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        #statusText {
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(99, 102, 241, 0.1);
        }

        /* Board Styling */
        .board-container {
            background: #2563eb;
            padding: 10px;
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5), 0 10px 25px rgba(0, 0, 0, 0.3);
            margin: 0 auto;
            width: fit-content;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(7, 50px);
            grid-template-rows: repeat(6, 50px);
            gap: 8px;
        }

        @media(max-width: 500px) {
            .board {
                grid-template-columns: repeat(7, 35px);
                grid-template-rows: repeat(6, 35px);
                gap: 5px;
            }
        }

        .cell {
            background: var(--bg-main);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .cell:hover {
            filter: brightness(0.8);
        }

        .cell.red {
            background: radial-gradient(circle at 15px 15px, #f87171, #dc2626);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), inset 0 -3px 5px rgba(0, 0, 0, 0.3);
        }

        .cell.yellow {
            background: radial-gradient(circle at 15px 15px, #fde047, #eab308);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), inset 0 -3px 5px rgba(0, 0, 0, 0.3);
        }

        .cell.win {
            box-shadow: 0 0 15px 5px #10b981;
            transform: scale(1.1);
        }

        .players-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            max-width: 450px;
            margin: 0 auto 15px auto;
        }

        .p-red {
            color: #dc2626;
        }

        .p-yellow {
            color: #eab308;
        }
    </style>
</head>

<body>
    <div class="dashboard-layout" id="dashboard-wrapper">
        <div id="sidebar-placeholder"></div>
        <main class="main-content">
            <div id="header-placeholder"></div>

            <div class="page-body">
                <div class="connect4-container fade-in">
                    <div class="header">
                        <h2><i class="fas fa-th" style="margin-right: 10px;"></i> Connect 4</h2>
                        <p>Play Online, vs CPU, or Local 2-Player</p>
                    </div>

                    <div class="multiplayer-controls" id="connectionPanel">
                        <h3 style="text-align: center; margin-bottom: 10px;">Online Multiplayer</h3>
                        <div class="control-group">
                            <input type="text" id="usernameInput" placeholder="Enter Username..." required>
                        </div>
                        <div class="control-group">
                            <button class="btn-action" onclick="createRoom()"><i class="fas fa-plus"></i> Create
                                Room</button>
                            <span style="align-self: center;">OR</span>
                            <input type="text" id="roomcodeInput" placeholder="Enter Room Code">
                            <button class="btn-action" onclick="joinRoom()"><i class="fas fa-sign-in-alt"></i> Join
                                Room</button>
                        </div>

                        <hr style="border: 1px solid var(--border-color); width: 100%; margin: 10px 0;">
                        <h3 style="text-align: center; margin-bottom: 5px;">Offline Play</h3>

                        <div class="control-group">
                            <button class="btn-action"
                                style="background: var(--bg-card-2); color: var(--text-color); border: 2px solid var(--primary-color);"
                                onclick="startCPU()"><i class="fas fa-robot"></i> VS CPU</button>
                            <button class="btn-action"
                                style="background: var(--bg-card-2); color: var(--text-color); border: 2px solid #10b981;"
                                onclick="startLocal()"><i class="fas fa-user-friends"></i> VS Local Friend</button>
                        </div>
                    </div>

                    <div id="statusText">Waiting to connect...</div>

                    <div id="gameArea" style="display: none;">
                        <div class="players-info">
                            <span id="playerRedLabel" class="p-red">Red: ?</span>
                            <span id="playerYellowLabel" class="p-yellow">Yellow: ?</span>
                        </div>

                        <div class="board-container">
                            <div class="board" id="board">
                                <!-- 42 cells generated by JS -->
                            </div>
                        </div>

                        <div class="action-bar"
                            style="display: flex; justify-content: center; gap: 8px; margin-top: 20px; flex-wrap: wrap;">
                            <button class="btn-action" style="padding: 8px 12px; font-size: 0.9rem;"
                                onclick="resetBoard()"><i class="fas fa-redo"></i> Play Again</button>
                            <button class="btn-action"
                                style="padding: 8px 12px; font-size: 0.9rem; background: var(--bg-card-2); border: 1px solid var(--border-color); color: var(--text-color);"
                                onclick="quitGame()"><i class="fas fa-sign-out-alt"></i> Quit</button>
                        </div>
                    </div>

                </div>
            </div>

            <div id="footer-placeholder"></div>
        </main>
    </div>

    <script>
        window.FRONTEND_ROOT = "/";
    </script>
    <script src="/js/app.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        // Game State
        const COLS = 7;
        const ROWS = 6;
        let boardState = Array(ROWS).fill(null).map(() => Array(COLS).fill(0));
        // 0 = empty, 1 = Red, 2 = Yellow

        let currentPlayer = 1;
        let myColor = 1;
        let isGameActive = false;
        let playMode = 'local'; // 'local', 'cpu', 'online'
        let currentRoom = null;
        let username = '';

        // UI Elements
        const boardEl = document.getElementById('board');
        const statusText = document.getElementById('statusText');
        const connectionPanel = document.getElementById('connectionPanel');
        const gameArea = document.getElementById('gameArea');
        const playerRedLabel = document.getElementById('playerRedLabel');
        const playerYellowLabel = document.getElementById('playerYellowLabel');

        let socket = null;
        if (typeof io !== 'undefined') {
            socket = io();
        }

        // Initialize board UI
        function createBoard() {
            boardEl.innerHTML = '';
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.id = `cell-${r}-${c}`;
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.addEventListener('click', () => handleColumnClick(c));
                    boardEl.appendChild(cell);
                }
            }
        }

        function updateBoardUI() {
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = document.getElementById(`cell-${r}-${c}`);
                    cell.className = 'cell'; // reset
                    if (boardState[r][c] === 1) cell.classList.add('red');
                    if (boardState[r][c] === 2) cell.classList.add('yellow');
                }
            }
            checkWinStateUI();
        }

        function getEmptyRow(col) {
            for (let r = ROWS - 1; r >= 0; r--) {
                if (boardState[r][col] === 0) return r;
            }
            return -1;
        }

        function handleColumnClick(col) {
            if (!isGameActive) return;

            // Turn enforcement
            if (playMode === 'online' && currentPlayer !== myColor) return;
            if (playMode === 'cpu' && currentPlayer !== 1) return; // User is Red(1) in CPU mode

            let row = getEmptyRow(col);
            if (row === -1) return; // Column full

            makeMove(row, col, currentPlayer);

            // Handle Network
            if (playMode === 'online') {
                socket.emit('game_action', {
                    roomCode: currentRoom,
                    action: 'connect4_move',
                    payload: { row: row, col: col, color: myColor }
                });
            } else if (playMode === 'cpu' && isGameActive) {
                // Trigger CPU Move
                statusText.innerText = "CPU is dropping...";
                setTimeout(makeCPUMove, 500);
            }
        }

        function makeMove(row, col, playerColor) {
            boardState[row][col] = playerColor;
            currentPlayer = playerColor === 1 ? 2 : 1;
            updateBoardUI();
            checkGameState();
        }

        function checkWin(board) {
            // Horizontal
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS - 3; c++) {
                    if (board[r][c] !== 0 && board[r][c] === board[r][c + 1] && board[r][c] === board[r][c + 2] && board[r][c] === board[r][c + 3]) {
                        return { winner: board[r][c], pattern: [[r, c], [r, c + 1], [r, c + 2], [r, c + 3]] };
                    }
                }
            }
            // Vertical
            for (let r = 0; r < ROWS - 3; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (board[r][c] !== 0 && board[r][c] === board[r + 1][c] && board[r][c] === board[r + 2][c] && board[r][c] === board[r + 3][c]) {
                        return { winner: board[r][c], pattern: [[r, c], [r + 1, c], [r + 2, c], [r + 3, c]] };
                    }
                }
            }
            // Diagonal right
            for (let r = 0; r < ROWS - 3; r++) {
                for (let c = 0; c < COLS - 3; c++) {
                    if (board[r][c] !== 0 && board[r][c] === board[r + 1][c + 1] && board[r][c] === board[r + 2][c + 2] && board[r][c] === board[r + 3][c + 3]) {
                        return { winner: board[r][c], pattern: [[r, c], [r + 1, c + 1], [r + 2, c + 2], [r + 3, c + 3]] };
                    }
                }
            }
            // Diagonal left
            for (let r = 3; r < ROWS; r++) {
                for (let c = 0; c < COLS - 3; c++) {
                    if (board[r][c] !== 0 && board[r][c] === board[r - 1][c + 1] && board[r][c] === board[r - 2][c + 2] && board[r][c] === board[r - 3][c + 3]) {
                        return { winner: board[r][c], pattern: [[r, c], [r - 1, c + 1], [r - 2, c + 2], [r - 3, c + 3]] };
                    }
                }
            }

            // Check tie
            let isTie = true;
            for (let c = 0; c < COLS; c++) {
                if (board[0][c] === 0) isTie = false;
            }
            if (isTie) return { winner: 'Tie' };

            return null;
        }

        function checkWinStateUI() {
            let winObj = checkWin(boardState);
            if (winObj && winObj.winner !== 'Tie') {
                winObj.pattern.forEach(p => {
                    document.getElementById(`cell-${p[0]}-${p[1]}`).classList.add('win');
                });
            }
        }

        function checkGameState() {
            let res = checkWin(boardState);
            if (res) {
                isGameActive = false;
                if (res.winner === 'Tie') {
                    statusText.innerText = "It's a Tie!";
                } else if (res.winner === 1) {
                    statusText.innerText = `Red Wins!`;
                    statusText.className = "p-red";
                } else {
                    statusText.innerText = `Yellow Wins!`;
                    statusText.className = "p-yellow";
                }
                statusText.style.background = 'var(--bg-card)';
                statusText.style.border = '2px solid var(--border-color)';
            } else {
                updateStatusText();
            }
        }

        function updateStatusText() {
            statusText.style.background = 'rgba(99, 102, 241, 0.1)';
            statusText.style.border = 'none';
            statusText.className = '';

            let colorStr = currentPlayer === 1 ? 'Red' : 'Yellow';

            if (playMode === 'online') {
                statusText.innerText = currentPlayer === myColor ? "Your Turn!" : "Waiting for opponent...";
                if (currentPlayer === myColor) statusText.style.color = currentPlayer === 1 ? '#dc2626' : '#eab308';
                else statusText.style.color = "var(--primary-color)";
            } else if (playMode === 'cpu') {
                statusText.innerText = currentPlayer === 1 ? "Your Turn! (Red)" : "CPU's Turn... (Yellow)";
                statusText.style.color = currentPlayer === 1 ? '#dc2626' : '#eab308';
            } else {
                statusText.innerText = `${colorStr}'s Turn!`;
                statusText.style.color = currentPlayer === 1 ? '#dc2626' : '#eab308';
            }
        }

        function resetBoard(emit = true) {
            boardState = Array(ROWS).fill(null).map(() => Array(COLS).fill(0));
            currentPlayer = 1;
            isGameActive = true;
            updateBoardUI();
            updateStatusText();

            if (playMode === 'online' && emit) {
                socket.emit('game_action', { roomCode: currentRoom, action: 'connect4_reset' });
            }
        }

        function quitGame() {
            connectionPanel.style.display = 'block';
            gameArea.style.display = 'none';
            statusText.innerText = 'Select a Game Mode';
            statusText.className = '';
            statusText.style.color = 'var(--primary-color)';
            isGameActive = false;
            if (playMode === 'online') {
                socket.emit('leave_room', { roomCode: currentRoom });
            }
        }

        // --- CPU AI (Basic Random for C4) ---
        function makeCPUMove() {
            if (!isGameActive) return;

            // Collect valid columns
            let validCols = [];
            for (let c = 0; c < COLS; c++) {
                if (getEmptyRow(c) !== -1) validCols.push(c);
            }

            if (validCols.length === 0) return; // Board full fallback
            let randomCol = validCols[Math.floor(Math.random() * validCols.length)];
            let row = getEmptyRow(randomCol);

            makeMove(row, randomCol, 2); // CPU is Yellow(2)
        }

        // --- OFFLINE MODES ---
        function startCPU() {
            playMode = 'cpu';
            myColor = 1;
            connectionPanel.style.display = 'none';
            gameArea.style.display = 'block';
            playerRedLabel.innerText = "Player: Red";
            playerYellowLabel.innerText = "CPU: Yellow";
            createBoard();
            resetBoard();
        }

        function startLocal() {
            playMode = 'local';
            connectionPanel.style.display = 'none';
            gameArea.style.display = 'block';
            playerRedLabel.innerText = "Player 1: Red";
            playerYellowLabel.innerText = "Player 2: Yellow";
            createBoard();
            resetBoard();
        }

        // --- ONLINE SOCKETS ---
        function createRoom() {
            username = document.getElementById('usernameInput').value.trim();
            if (!username) return alert("Please enter a username");

            playMode = 'online';
            if (!socket) socket = io();
            socket.emit('create_room', { gameType: 'connect4', username });

            // Wait for response
            socket.once('room_created', (data) => {
                currentRoom = data.roomCode;
                myColor = 1; // Creator starts as Red(1)
                playerRedLabel.innerText = `You: Red`;
                playerYellowLabel.innerText = `Waiting...`;
                setupOnlineMatch(data.roomCode);
            });
        }

        function joinRoom() {
            username = document.getElementById('usernameInput').value.trim();
            let code = document.getElementById('roomcodeInput').value.trim();
            if (!username || !code) return alert("Please enter a username and Room Code");

            playMode = 'online';
            if (!socket) socket = io();
            socket.emit('join_room', { roomCode: code, username });

            socket.once('room_joined', (data) => {
                currentRoom = data.roomCode;
                myColor = 2; // Joiner is Yellow(2)
                playerRedLabel.innerText = `Waiting...`;
                playerYellowLabel.innerText = `You: Yellow`;
                setupOnlineMatch(data.roomCode);
            });

            socket.once('error', (msg) => {
                alert(msg);
            });
        }

        function setupOnlineMatch(roomCode) {
            connectionPanel.style.display = 'none';
            gameArea.style.display = 'block';
            statusText.innerText = "Room Code: " + roomCode + " (Waiting for opponent)";
            createBoard();
            isGameActive = false; // Wait until player connects
        }

        // Live Socket Listeners
        if (socket) {
            socket.on('player_connected', (data) => {
                if (playMode !== 'online') return;
                statusText.innerText = "Opponent joined! Game starting...";
                if (myColor === 1) {
                    playerYellowLabel.innerText = `Opponent: Yellow`;
                } else {
                    playerRedLabel.innerText = `Opponent: Red`;
                }
                setTimeout(() => resetBoard(false), 2000);
            });

            socket.on('player_disconnected', (data) => {
                if (playMode !== 'online') return;
                statusText.innerText = "Opponent left the room!";
                isGameActive = false;
            });

            socket.on('game_action', (data) => {
                if (playMode !== 'online' || data.roomCode !== currentRoom) return;

                if (data.action === 'connect4_move') {
                    makeMove(data.payload.row, data.payload.col, data.payload.color);
                } else if (data.action === 'connect4_reset') {
                    resetBoard(false);
                }
            });
        }

        // Boot
        createBoard();
    </script>
</body>

</html>