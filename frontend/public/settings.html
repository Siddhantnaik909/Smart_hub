<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMART HUB | Settings</title>
    <!-- Shared Head Links -->
    <div id="head-links"></div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/custom.css">
</head>

<body>
    <div class="dashboard-layout" id="dashboard-wrapper">
        <div class="overlay" id="mobile-overlay"></div>
        <div id="sidebar-placeholder"></div>
        <main class="main-content">
            <div id="header-placeholder"></div>
            <div class="page-body">
                <section class="container" style="margin-top: 40px;">
                    <div style="margin-bottom: 30px;">
                        <h1>User <span class="accent-text">Settings</span></h1>
                        <p style="opacity: 0.7;">Manage your profile, theme preferences, and data.</p>
                    </div>

                    <div class="category-grid">
                        <!-- Profile Section -->
                        <article class="cat-card">
                            <div class="cat-icon_wrapper indigo-theme"><i class="fa-solid fa-user-gear"></i></div>
                            <h3>Profile Details</h3>
                            <form id="profile-form"
                                style="margin-top: 20px; display: flex; flex-direction: column; gap: 15px;">
                                <div class="sub-link"
                                    style="flex-direction: column; align-items: flex-start; gap: 5px;">
                                    <span>Full Name</span>
                                    <input type="text" id="edit-name" class="form-control" style="width: 100%;"
                                        placeholder="Your Name">
                                </div>
                                <div class="sub-link"
                                    style="flex-direction: column; align-items: flex-start; gap: 10px;">
                                    <span>Profile Photo</span>
                                    <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                                        <div id="photo-preview-container"
                                            style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; border: 2px solid var(--primary-color);">
                                            <img id="profile-preview" src="https://via.placeholder.com/150"
                                                style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div style="flex: 1;">
                                            <input type="file" id="photo-upload" accept="image/*"
                                                style="display: none;">
                                            <button type="button" class="btn-secondary"
                                                onclick="document.getElementById('photo-upload').click()"
                                                style="width: 100%; padding: 8px; font-size: 0.85rem;">
                                                <i class="fa-solid fa-camera"></i> Change Photo
                                            </button>
                                            <p style="font-size: 0.7rem; opacity: 0.6; margin-top: 5px;">Supports: JPG,
                                                PNG, WEBP (Max 5MB)</p>
                                        </div>
                                    </div>
                                    <input type="text" id="edit-photo" class="form-control"
                                        style="width: 100%; display:none;">
                                </div>
                                <div class="sub-link"
                                    style="flex-direction: column; align-items: flex-start; gap: 5px;">
                                    <span>Email Address</span>
                                    <input type="email" id="settings-email" class="form-control"
                                        style="width: 100%; opacity: 0.6;" readonly>
                                </div>
                                <button type="submit" class="btn-save" id="btn-update-profile"
                                    style="margin-top: 10px; width: 100%; padding: 12px; border-radius: 10px; font-weight: 600;">Update
                                    Profile</button>
                            </form>
                        </article>

                        <!-- Preferences Section -->
                        <article class="cat-card">
                            <div class="cat-icon_wrapper cyan-theme"><i class="fa-solid fa-sliders"></i></div>
                            <h3>App Preferences</h3>
                            <div class="sub-cat-list" style="margin-top: 20px;">
                                <div class="sub-link">
                                    <span>Dark Mode</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="settings-theme-toggle"
                                            onchange="toggleDarkMode(this)">
                                        <div class="slider"></div>
                                    </label>
                                </div>
                                <div class="sub-link">
                                    <span>Compact UI</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="compact-toggle" onchange="toggleCompactMode(this)">
                                        <div class="slider"></div>
                                    </label>
                                </div>
                            </div>

                            <h4 style="margin-top:25px; margin-bottom:10px; opacity:0.8;">Layout & Theme</h4>
                            <div class="sub-cat-list">
                                <div class="sub-link"
                                    style="flex-direction: column; align-items: flex-start; gap: 5px;">
                                    <span>Sidebar/Navbar Position</span>
                                    <select class="form-control" id="layout-select"
                                        style="width: 100%; padding:8px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-card); color:var(--text-header);"
                                        onchange="setLayoutMode(this.value)">
                                        <option value="left">Left (Default)</option>
                                        <option value="right">Right</option>
                                        <option value="top">Top AppBar Menu</option>
                                        <option value="bottom">Bottom Navigation</option>
                                    </select>
                                </div>
                                <div class="sub-link"
                                    style="flex-direction: column; align-items: flex-start; gap: 5px;">
                                    <span>Accent Color</span>
                                    <div style="display:flex; gap:10px; margin-top:5px; flex-wrap:wrap;">
                                        <button onclick="setThemeColor('#6366f1')"
                                            style="width:30px; height:30px; border-radius:50%; background:#6366f1; border:2px solid rgba(255,255,255,0.2); cursor:pointer;"
                                            title="Indigo"></button>
                                        <button onclick="setThemeColor('#06b6d4')"
                                            style="width:30px; height:30px; border-radius:50%; background:#06b6d4; border:2px solid rgba(255,255,255,0.2); cursor:pointer;"
                                            title="Cyan"></button>
                                        <button onclick="setThemeColor('#8b5cf6')"
                                            style="width:30px; height:30px; border-radius:50%; background:#8b5cf6; border:2px solid rgba(255,255,255,0.2); cursor:pointer;"
                                            title="Purple"></button>
                                        <button onclick="setThemeColor('#ef4444')"
                                            style="width:30px; height:30px; border-radius:50%; background:#ef4444; border:2px solid rgba(255,255,255,0.2); cursor:pointer;"
                                            title="Red"></button>
                                        <button onclick="setThemeColor('#10b981')"
                                            style="width:30px; height:30px; border-radius:50%; background:#10b981; border:2px solid rgba(255,255,255,0.2); cursor:pointer;"
                                            title="Emerald"></button>
                                        <button onclick="setThemeColor('#f59e0b')"
                                            style="width:30px; height:30px; border-radius:50%; background:#f59e0b; border:2px solid rgba(255,255,255,0.2); cursor:pointer;"
                                            title="Amber"></button>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <!-- Data Management -->
                        <article class="cat-card">
                            <div class="cat-icon_wrapper purple-theme"><i class="fa-solid fa-database"></i></div>
                            <h3>Data Management</h3>
                            <div class="sub-cat-list" style="margin-top: 20px;">
                                <button class="sub-link" onclick="exportData()"
                                    style="background: none; width: 100%; border: none; cursor: pointer;">
                                    <span>Export History (JSON)</span>
                                    <i class="fa-solid fa-download"></i>
                                </button>
                                <button class="sub-link" onclick="clearLocalData()"
                                    style="background: none; width: 100%; border: none; cursor: pointer; color: #ef4444;">
                                    <span>Clear Local History</span>
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </article>

                        <!-- Multiplayer Lobby Section -->
                        <article class="cat-card" style="border: 2px dashed var(--primary-color);">
                            <div class="cat-icon_wrapper" style="background:var(--primary-color);color:white;"><i
                                    class="fa-solid fa-gamepad"></i></div>
                            <h3>Online Multiplayer</h3>
                            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px; margin-bottom: 15px;">Connect
                                with a friend and launch a game directly from here.</p>

                            <div id="mp-lobby-view">
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div id="btn-create-room-container">
                                        <button id="btn-create-room" class="btn-calc"
                                            onclick="window.mpCreateReadyRoom()" style="width:100%;"><i
                                                class="fa fa-plus"></i> Create Hub Room</button>
                                    </div>
                                    <div id="room-code-display-area"
                                        style="display: none; padding: 15px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); border: 2px dashed var(--primary-color); text-align: center; justify-content: space-between; align-items: center;">
                                        <div style="text-align: left;">
                                            <span style="font-size: 0.8rem; opacity: 0.8;">SHARE THIS CODE TO
                                                PLAY:</span><br>
                                            <strong style="font-size: 1.8rem; letter-spacing: 2px;"
                                                id="generated-room-code">-</strong>
                                        </div>
                                        <div><i class="fa fa-spinner fa-spin"
                                                style="font-size: 1.5rem; color: var(--primary-color);"></i><br><span
                                                style="font-size: 0.7rem; opacity:0.8;">Waiting for opponent</span>
                                        </div>
                                    </div>
                                    <div id="join-room-container"
                                        style="display: flex; gap: 5px; width: 100%; margin-top: 5px;">
                                        <input type="text" id="mp-room-code-input" class="form-control"
                                            placeholder="Enter Friend's Code to Join"
                                            style="text-transform: uppercase; flex:2;">
                                        <button class="btn-secondary" onclick="window.mpJoinReadyRoom()"
                                            style="flex:1;">Join Room</button>
                                    </div>
                                </div>
                            </div>

                            <div id="mp-active-view" style="display: none; flex-direction: column; gap:15px;">
                                <div
                                    style="padding: 15px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary-color); display:flex; justify-content:space-between; align-items:center;">
                                    <div><span style="font-size:0.8rem; opacity:0.7;">ROOM CODE</span><br><span
                                            style="font-size:1.5rem; font-weight:800;" id="mp-active-code"></span></div>
                                    <div style="text-align:right;"><span
                                            style="font-size:0.8rem; opacity:0.7;">STATUS</span><br><strong
                                            style="font-size:1.2rem; color: var(--accent-green);"
                                            id="mp-opponent-name">Waiting... <i
                                                class="fa fa-spinner fa-spin"></i></strong></div>
                                </div>

                                <div id="mp-game-launcher" style="display:none; flex-direction: column; gap: 10px;">
                                    <label style="font-size: 0.85rem; opacity: 0.8;">Select a Game to Play:</label>
                                    <select class="form-control" id="mp-game-select"
                                        style="width: 100%; border: 1px solid var(--border-color); background: var(--bg-input);">
                                        <option value="/calculators/fun/calc_rock_paper_scissors.html">Rock Paper
                                            Scissors</option>
                                        <option value="/calculators/fun/game_tic_tac_toe.html">Tic Tac Toe</option>
                                        <option value="/calculators/fun/game_connect4.html">Connect 4</option>
                                        <option value="/calculators/fun/calc_number_guesser.html">Number Guesser Pro
                                        </option>
                                    </select>
                                    <button class="btn-calc" onclick="window.mpLaunchGame()"
                                        style="width:100%; background:var(--accent-green);"><i
                                            class="fa-solid fa-play"></i> Start Match</button>
                                </div>
                            </div>
                        </article>
                    </div>
                </section>
                <div id="footer-placeholder"></div>
            </div>
        </main>
    </div>
    <script>
        window.FRONTEND_ROOT = "/";
        window.COMPONENT_ROOT = "/components/";

        // Preset layout selector on load
        function initSettingsUI() {
            const layoutMode = localStorage.getItem('layoutMode') || 'left';
            const ls = document.getElementById('layout-select');
            if (ls) ls.value = layoutMode;

            // Pre-fill profile form
            const userDataStr = localStorage.getItem('user');
            if (userDataStr) {
                const user = JSON.parse(userDataStr);
                const nameInput = document.getElementById('edit-name');
                const photoInput = document.getElementById('edit-photo');
                const emailInput = document.getElementById('settings-email');

                if (nameInput) nameInput.value = user.name || user.username || '';
                if (photoInput) photoInput.value = user.photo || '';
                if (emailInput) emailInput.value = user.email || '';

                const preview = document.getElementById('profile-preview');
                if (preview && user.photo) {
                    preview.src = user.photo.startsWith('http') ? user.photo : (window.API_URL || '') + user.photo;
                }
            }
        }

        // Preview image selection
        document.getElementById('photo-upload')?.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('profile-preview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // Handle Profile Update
        async function updateProfile(e) {
            e.preventDefault();

            const userStr = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            if (!userStr || !token) {
                alert("Please log in to update your profile."); return;
            }

            const user = JSON.parse(userStr);
            const newName = document.getElementById('edit-name').value.trim();
            const photoFile = document.getElementById('photo-upload').files[0];
            let newPhoto = document.getElementById('edit-photo').value.trim();

            const btnUpdate = document.getElementById('btn-update-profile');
            const originalText = btnUpdate.innerText;
            btnUpdate.innerText = "Processing...";
            btnUpdate.disabled = true;

            try {
                const targetUrl = window.API_URL || ((window.location.hostname === 'localhost') ? 'http://localhost:3000' : 'https://smart-hub-f5gw.onrender.com');

                // 1. Upload photo if selected
                if (photoFile) {
                    btnUpdate.innerText = "Uploading Photo...";
                    const formData = new FormData();
                    formData.append('profilePhoto', photoFile);

                    const uploadResponse = await fetch(`${targetUrl}/api/auth/upload-profile`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const errData = await uploadResponse.json().catch(() => ({}));
                        throw new Error(errData.message || "Photo upload failed.");
                    }
                    const uploadData = await uploadResponse.json();
                    newPhoto = uploadData.photoUrl;
                }

                // 2. Update profile data
                btnUpdate.innerText = "Saving Changes...";
                const response = await fetch(`${targetUrl}/api/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        id: user.id || user._id,
                        name: newName,
                        photo: newPhoto
                    })
                });

                if (!response.ok) throw new Error("Could not update profile on server.");

                const data = await response.json();
                localStorage.setItem('user', JSON.stringify(data.user));
                alert("Profile synchronized successfully!");

                // Refresh all profile images in UI
                window.location.reload();
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                btnUpdate.innerText = originalText;
                btnUpdate.disabled = false;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            initSettingsUI();
            const profileForm = document.getElementById('profile-form');
            if (profileForm) profileForm.addEventListener('submit', updateProfile);
        });
        // --- MULTIPLAYER LOGIC ---
        let mainLobbyClient = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('mp-active-view').style.display = 'none';
            if (window.MultiplayerClient) {
                mainLobbyClient = new window.MultiplayerClient("Hub Settings Lobby",
                    (players) => { // on Joined
                        const opp = players.find(p => p.id !== mainLobbyClient.socket.id);
                        document.getElementById('mp-lobby-view').style.display = 'none';
                        document.getElementById('mp-active-view').style.display = 'flex';
                        document.getElementById('mp-active-code').textContent = mainLobbyClient.roomCode;

                        if (opp) {
                            document.getElementById('mp-opponent-name').innerHTML = `${opp.username} Connected!`;
                            if (mainLobbyClient.isHost) {
                                document.getElementById('mp-game-launcher').style.display = 'flex';
                            } else {
                                document.getElementById('mp-opponent-name').innerHTML = `${opp.username} is picking a game...`;
                            }
                        }
                    },
                    (data) => { }, // Opponent Action (Launch handled automatically inside SDK)
                    (data) => {
                        alert(data.message);
                        window.location.reload();
                    }
                );

                // Capture room created hook inside the client to modify our lobby UI
                mainLobbyClient.onRoomReady = (code) => {
                    document.getElementById('btn-create-room-container').style.display = 'none';
                    document.getElementById('join-room-container').style.display = 'none'; // Hide join too to prevent confusion
                    document.getElementById('room-code-display-area').style.display = 'flex';
                    document.getElementById('generated-room-code').textContent = code;
                };
            }
        });

        window.mpCreateReadyRoom = () => mainLobbyClient && mainLobbyClient.createRoom();
        window.mpJoinReadyRoom = () => {
            const code = document.getElementById('mp-room-code-input').value;
            if (code && mainLobbyClient) mainLobbyClient.joinRoom(code);
        }
        window.mpLaunchGame = () => {
            if (!mainLobbyClient || !mainLobbyClient.isHost) return;
            const targetGame = document.getElementById('mp-game-select').value;
            mainLobbyClient.launchGame(targetGame); // Routes both clients
        }
    </script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="/js/multiplayerClient.js"></script>
    <script src="/js/component-loader.js"></script>
    <script type="module" src="/js/script.js"></script>
    <script src="/js/custom.js"></script>
</body>

</html>